<p-toast></p-toast>
<p-confirmDialog [style]="{ width: '450px' }"></p-confirmDialog>

<div class="board-container">
  <!-- Board Header -->
  <div class="board-header">
    <h1 class="board-title">{{ board.title }}</h1>
    <div class="board-actions">
      <p-button
        *ngIf="!addingNewColumn"
        icon="pi pi-plus"
        label="Añadir columna"
        (onClick)="addingNewColumn = true"
        styleClass="p-button-outlined"
      >
      </p-button>
    </div>
  </div>

  <!-- Board Content -->
  <div class="board-content">
    <!-- Columns container -->
    <div class="columns-container">
      <!-- Column -->
      <p-card *ngFor="let column of board.columns" styleClass="column">
        <!-- Column Header -->
        <ng-template pTemplate="header">
          <div
            *ngIf="editingColumnId !== column.id"
            class="column-title-container"
          >
            <h3 class="column-title" (click)="startEditingColumn(column)">
              {{ column.title }}
            </h3>
            <div class="column-actions">
              <p-button
                icon="pi pi-plus"
                (onClick)="openAddTaskModal(column)"
                pTooltip="Añadir tarea"
                styleClass="p-button-rounded p-button-text p-button-sm"
              >
              </p-button>
              <p-button
                icon="pi pi-trash"
                (onClick)="deleteColumn(column.id)"
                pTooltip="Eliminar columna"
                styleClass="p-button-rounded p-button-text p-button-danger p-button-sm"
              >
              </p-button>
            </div>
          </div>

          <div *ngIf="editingColumnId === column.id" class="column-edit">
            <span class="p-input-icon-right">
              <i
                class="pi pi-check"
                (click)="saveColumnTitle(column)"
                style="cursor: pointer"
              ></i>
              <input
                type="text"
                pInputText
                [(ngModel)]="editingColumnTitle"
                (keyup.enter)="saveColumnTitle(column)"
                (keyup.escape)="cancelColumnEdit()"
                autofocus
                class="w-full"
              />
            </span>
          </div>
        </ng-template>

        <!-- Column Tasks -->
        <div
          class="column-tasks"
          cdkDropList
          [cdkDropListData]="column.tasks"
          (cdkDropListDropped)="drop($event)"
          [id]="column.id"
        >
          <!-- Task Card -->
          <p-card
            *ngFor="let task of column.tasks"
            styleClass="task-card"
            cdkDrag
            [cdkDragData]="task"
            (click)="openEditTaskModal(task, column)"
          >
            <div class="task-labels" *ngIf="task.labels.length">
              <span
                class="task-label"
                *ngFor="let label of task.labels"
                [style.background-color]="label"
              >
              </span>
            </div>

            <div class="task-title">{{ task.title }}</div>

            <div class="task-footer">
              <div class="task-meta">
                <div
                  class="task-due"
                  *ngIf="task.dueDate"
                  [class.task-overdue]="isOverdue(task)"
                  [class.task-due-soon]="isDueSoon(task)"
                >
                  <i class="pi pi-calendar"></i>
                  {{ formatDate(task.dueDate) }}
                </div>

                <div class="task-assignee" *ngIf="task.assignedTo">
                  <p-badge
                    [value]="task.assignedTo.charAt(0)"
                    styleClass="assignee-badge"
                  ></p-badge>
                </div>
              </div>
            </div>
          </p-card>

          <div class="column-empty" *ngIf="column.tasks.length === 0">
            No hay tareas
          </div>
        </div>

        <ng-template pTemplate="footer">
          <!-- Add Task Button -->
          <p-button
            label="Añadir tarea"
            icon="pi pi-plus"
            (onClick)="openAddTaskModal(column)"
            styleClass="p-button-text p-button-sm w-full"
          >
          </p-button>
        </ng-template>
      </p-card>

      <!-- Add New Column Form -->
      <p-card *ngIf="addingNewColumn" styleClass="column new-column">
        <div class="new-column-form">
          <span class="p-float-label mb-3">
            <input
              id="newColumnTitle"
              type="text"
              pInputText
              [(ngModel)]="newColumnTitle"
              (keyup.enter)="addColumn()"
              autofocus
              class="w-full"
            />
            <label for="newColumnTitle">Título de la columna</label>
          </span>

          <div class="flex gap-2">
            <p-button
              label="Añadir"
              (onClick)="addColumn()"
              [disabled]="newColumnTitle.trim() === ''"
              styleClass="p-button-sm"
            >
            </p-button>
            <p-button
              label="Cancelar"
              (onClick)="addingNewColumn = false"
              styleClass="p-button-outlined p-button-sm"
            >
            </p-button>
          </div>
        </div>
      </p-card>

      <!-- Add Column Button -->
      <p-button
        *ngIf="!addingNewColumn"
        icon="pi pi-plus"
        label="Añadir columna"
        (onClick)="addingNewColumn = true"
        styleClass="p-button-outlined add-column-btn"
      >
      </p-button>
    </div>
  </div>

  <!-- Task Modal -->
  <p-dialog
    [(visible)]="showTaskModal"
    [modal]="true"
    [draggable]="false"
    [resizable]="false"
    [style]="{ width: '550px' }"
    [header]="modalMode === 'create' ? 'Nueva Tarea' : 'Editar Tarea'"
    [closeOnEscape]="true"
    [dismissableMask]="true"
  >
    <div class="grid">
      <div class="col-12">
        <span class="p-float-label">
          <input
            id="taskTitle"
            type="text"
            pInputText
            [(ngModel)]="taskTitle"
            class="w-full"
          />
          <label for="taskTitle">Título</label>
        </span>
      </div>

      <div class="col-12 mt-4">
        <span class="p-float-label">
          <textarea
            id="taskDescription"
            pInputTextarea
            [(ngModel)]="taskDescription"
            rows="3"
            class="w-full"
          ></textarea>
          <label for="taskDescription">Descripción</label>
        </span>
      </div>

      <div class="col-12 mt-4">
        <label class="block mb-2">Etiquetas</label>
        <div class="flex flex-wrap gap-2">
          <div
            *ngFor="let label of labelColors"
            class="label-option"
            [class.selected]="isLabelSelected(label.value)"
            [style.background-color]="label.value"
            (click)="toggleLabel(label.value)"
            [pTooltip]="label.name"
          ></div>
        </div>
      </div>

      <div class="col-12 mt-4">
        <span class="p-float-label">
          <p-calendar
            id="taskDueDate"
            [(ngModel)]="taskDueDate"
            [showIcon]="true"
            dateFormat="dd/mm/yy"
            [showButtonBar]="true"
            class="w-full"
          ></p-calendar>
          <label for="taskDueDate">Fecha límite</label>
        </span>
      </div>

      <div class="col-12 mt-4">
        <span class="p-float-label">
          <input
            id="taskAssignee"
            type="text"
            pInputText
            [(ngModel)]="taskAssignee"
            class="w-full"
          />
          <label for="taskAssignee">Asignado a</label>
        </span>
      </div>
    </div>

    <ng-template pTemplate="footer">
      <p-button
        *ngIf="modalMode === 'edit'"
        label="Eliminar"
        icon="pi pi-trash"
        (onClick)="deleteTask(editingTask!.id, selectedColumn!)"
        styleClass="p-button-danger p-button-outlined mr-2"
      >
      </p-button>
      <p-button
        label="Cancelar"
        icon="pi pi-times"
        (onClick)="closeTaskModal()"
        styleClass="p-button-outlined mr-2"
      >
      </p-button>
      <p-button
        label="Guardar"
        icon="pi pi-check"
        (onClick)="modalMode === 'create' ? saveNewTask() : saveTaskChanges()"
        [disabled]="taskTitle.trim() === ''"
      >
      </p-button>
    </ng-template>
  </p-dialog>
</div>
